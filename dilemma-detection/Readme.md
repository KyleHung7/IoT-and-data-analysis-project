# 基於 YOLOv8 的車輛兩難區間偵測系統 (Dilemma Zone Detection System)

本專案利用電腦視覺技術，對交通路口的影像進行分析，旨在即時偵測並標示出處於「兩難區間 (Dilemma Zone)」的車輛。

「兩難區間」是指當交通號誌變為黃燈時，駕駛員既無法在停止線前安全地煞停，也無法在號誌變為紅燈前順利通過路口的一段區域。對此區域的偵測有助於分析路口安全風險與交通流量。

本系統整合了 YOLOv8 物件偵測模型、透視變換以及自定義的車輛追蹤與過濾演算法，以實現準確的偵測。

## 主要功能

*   **即時車輛偵測**: 使用輕量級的 YOLOv8n 模型偵測影片中的車輛（汽車、機車、巴士、卡車）。
*   **透視變換**: 透過使用者手動選取四個角點，將影像中的梯形區域轉換為鳥瞰圖（Bird's-eye View），以便在真實世界的公尺單位下進行距離與速度的計算。
*   **車輛追蹤**: 為每輛進入偵測區域的車輛分配一個獨特的 ID，並在連續的影格中追蹤其軌跡。
*   **速度與距離估算**: 在鳥瞰圖中計算每輛車的平滑速度（m/s）以及其到停止線的距離（m）。
*   **兩難區間（Dilemma Zone）計算**: 根據標準的交通工程學公式，計算每輛車的煞停臨界距離（Xc）與通過臨界距離（X0），並判斷其是否處於兩難區間內。
*   **智慧型過濾機制**:
    *   **靜態物體過濾**: 自動識別並過濾掉長時間靜止的物體（如地面上的箭頭標線），避免誤判。
    *   **已停止車輛過濾**: 自動忽略在停止線前已經停下或速度極慢的車輛，專注於正在接近路口的車輛。
*   **視覺化與數據輸出**:
    *   **影像輸出**: 生成一個標註了偵測結果的影片 (`dilemma_zone_output.avi`)。
    *   **數據輸出**: 將詳細的偵測數據匯出為 CSV 檔案 (`dilemma_zone_results.csv`)，方便後續分析。

## 核心計算過程詳解

系統的核心在於將影像中的像素資訊轉換為真實世界的物理量（速度、距離），並依此進行判斷。以下是關鍵步驟：

### 1. 座標轉換 (Perspective Transform)

*   **目的**: 消除影像的透視失真，將車輛位置從 2D 影像平面（單位：像素）映射到一個 2D 鳥瞰圖平面（單位：公尺）。這使得我們可以進行真實的距離測量。
*   **過程**:
    1.  程式啟動時，使用者需選取影像中的四個點，定義一個梯形區域（ROI）。
    2.  這四個點會被映射到一個預先定義好的矩形上（例如，一個代表三車道寬、數十公尺長的區域）。
    3.  使用 `cv2.getPerspectiveTransform` 函數計算出一個 3x3 的變換矩陣 `M`。
    4.  在後續的每一幀中，偵測到的車輛中心點 `(x, y)` 都會透過 `cv2.perspectiveTransform` 和矩陣 `M` 進行轉換，得到其在鳥瞰圖中的新座標。

### 2. 軌跡與平滑速度計算 (Trajectory and Smoothed Speed)

*   **目的**: 由於單幀的物件偵測結果可能會有微小抖動（Jitter），直接用兩幀計算出的「瞬時速度」噪點很大。我們需要一個更穩定、可靠的速度值。
*   **過程**:
    1.  **軌跡記錄**: 系統為每個追蹤到的車輛 `vid` 維護一個 `deque`（雙向佇列），記錄其最近 N 幀在鳥瞰圖中的座標歷史。
    2.  **滑動窗口平滑**: `calculate_smoothed_speed` 函數會取軌跡中的最近 `SMOOTHING_WINDOW` 筆座標。
    3.  **平均速度**: 函數會計算這個窗口內每兩個連續點之間的瞬時速度，然後將這些速度值取平均。
    4.  **結果**: 得到一個平滑後的速度 `v_smooth` (單位: m/s)，這個值能更好地反映車輛的真實運動趨勢。

### 3. 到停止線距離計算 (Distance to Stop Line)

*   **目的**: 獲取車輛當前位置到路口停止線的精確距離。
*   **過程**:
    *   在鳥瞰圖座標系中，停止線被視為一條水平線，其 Y 座標 `stopline_topview_y` 在初始化時就已計算好。
    *   車輛到停止線的距離 `d_m` 可以簡單地透過其當前 Y 座標與停止線 Y 座標的差來計算。
    *   `d_m = (vehicle_current_y - stopline_topview_y) / 100.0`
        > *註：座標在計算時被放大了 100 倍以提高精度，此處需除以 100 還原為公尺*

### 4. 兩難區間判斷 (Dilemma Zone Judgment)

這是整個系統的核心邏輯，基於車輛的平滑速度 `v0` 和距離 `d_m` 進行判斷。

*   **煞停臨界距離 (Critical Stopping Distance, Xc)**:
    *   **定義**: 車輛在當前速度下，能夠安全舒適地在停止線前停下所需的最小距離。
    *   **公式**: `Xc = v0 * delta1 + v0**2 / (2 * a1)`
    *   **解析**:
        *   `v0 * delta1`: 駕駛員的反應時間 `delta1` 內，車輛繼續行駛的距離。
        *   `v0**2 / (2 * a1)`: 物理學中的煞車距離公式，表示從開始煞車到完全停止所需的距離，其中 `a1` 是最大舒適減速度。
    *   **意義**: 如果車輛距離 `d_m` 小於 `Xc`，代表它已經太靠近路口，無法舒適地煞停。

*   **通過臨界距離 (Critical Passing Distance, X0)**:
    *   **定義**: 車輛在當前速度下，能夠在號誌變為紅燈前剛好完全通過路口（車尾離開路口）的最大起始距離。
    *   **公式**: `X0 = v0 * tau - 0.5 * a2 * (tau - delta2)**2 - W - L`
    *   **解析**:
        *   `v0 * tau`: 在黃燈持續時間 `tau` 內，車輛以當前速度行駛的總距離。
        *   `0.5 * a2 * (tau - delta2)**2`: 一個修正項，考慮了駕駛員反應時間 `delta2` 和可能的減速度 `a2`。
        *   `W + L`: 車輛需要「清除」的距離，即路口寬度 `W` 加上車身長度 `L`。
    *   **意義**: 如果車輛距離 `d_m` 大於 `X0`，代表它離路口太遠，即使黃燈亮起時立刻加速，也無法在紅燈前完全通過。

*   **最終判斷**:
    *   當車輛的實際距離 `d_m` 同時滿足以下兩個條件時，它就處於兩難區間：
        *   `d_m < Xc` (無法安全停車)
        *   `d_m > X0` (無法安全通過)
    *   **判斷式**: `if X0 < d_m < Xc:`

## 環境需求

*   Python 3.8+
*   OpenCV
*   NumPy
*   Pandas
*   Ultralytics (YOLOv8)

您可以使用以下指令安裝所有必要的套件：
```bash
pip install opencv-python numpy pandas ultralytics
```

## 如何使用

1.  **設定影片路徑**:
    修改程式碼中的 `video_path` 變數，使其指向您要分析的影片檔案。
    ```python
    video_path = r"path/to/your/video.mp4"
    ```

2.  **執行程式**:
    在終端機中執行 Python 腳本。
    ```bash
    python your_script_name.py
    ```

3.  **選取角點**:
    *   程式會彈出一個顯示影片第一幀的視窗。
    *   請依照提示，用滑鼠依序點擊四個角點：停止線左側 -> 停止線右側 -> 畫面底端左側 -> 畫面底端右側。
    *   選取完成後，在視窗上按任意鍵繼續。

4.  **處理與等待**:
    *   程式會開始逐幀處理影片，並顯示即時的偵測結果視窗。
    *   您可以隨時按下 `q` 鍵來提前終止處理。

5.  **查看結果**:
    *   處理完成後，程式會在同一個資料夾下生成 `dilemma_zone_output.avi` 和 `dilemma_zone_results.csv` 兩個檔案。

## 參數配置

您可以在程式碼的開頭部分調整以下參數以適應不同的場景：

*   **Dilemma Zone 公式參數**: `delta1`, `tau`, `a1` 等，這些是交通工程學的標準參數，可根據研究需求調整。
*   **追蹤與過濾參數**:
    *   `SMOOTHING_WINDOW`: 用於計算平滑速度的影格數，值越大速度越穩定，但反應越慢。
    *   `STOPPED_SPEED_THRESHOLD`: 判定車輛為「已停止」的速度上限。
    *   `MAX_AGE`: 一個追蹤 ID 在失追後可以保留的最大影格數。
    *   `STATIC_CHECK_FRAME_THRESHOLD` / `STATIC_DISPLACEMENT_THRESHOLD`: 用於判斷靜態物體的參數。

## 輸出說明

### 影片輸出 (`dilemma_zone_output.avi`)

*   **綠色框**: 正常行駛的車輛。
*   **紅色框**: 被判定處於兩難區間的車輛。
*   **黃色框 (Stopped)**: 被判定為已在停止線前停下的車輛。
*   **青色框 (Static)**: 被判定為靜態物體（如地面標線）。

### CSV 數據輸出 (`dilemma_zone_results.csv`)

包含以下欄位：
*   `frame`: 影格編號
*   `vehicle_id`: 車輛的追蹤 ID
*   `speed_m_s`: 車輛的平滑速度 (公尺/秒)
*   `dist_to_stop_m`: 車輛距離停止線的距離 (公尺)
*   `X0`: 通過臨界距離 (公尺)
*   `Xc`: 煞停臨界距離 (公尺)
*   `dilemma_zone`: 是否處於兩難區間 (True/False)
